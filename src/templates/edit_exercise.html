<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditer un exercice</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']]
            }
        };
    </script>
    <style>
        .preview-box {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            min-height: 150px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
        .preview-title {
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        /* Styles pour Select2 avec Bulma */
        .select2-container--default .select2-selection--multiple {
            border-radius: 4px;
            border: 1px solid #dbdbdb;
        }
        
        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #3273dc;
            box-shadow: 0 0 0 0.125em rgba(50, 115, 220, 0.25);
        }
    </style>
</head>
<body>
    <section class="hero is-primary is-bold">
        <div class="hero-body">
            <div class="container">
                <h1 class="title has-text-centered">Éditer un exercice</h1>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <form action="/edit_exercise" method="POST">
                <div class="field">
                    <label class="label">ID</label>
                    <div class="control">
                        <input class="input" type="text" name="id" value="{{ exercice.id }}" readonly>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Niveau</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="level_id" name="level_id" required>
                                <option value="">Sélectionnez un niveau</option>
                                {% for level in levels %}
                                    <option value="{{ level.id }}" {% if exercice.level_id == level.id %}selected{% endif %}>{{ level.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Thème</label>
                    <div class="control">
                        <div class="select is-fullwidth">
                            <select id="theme_id" name="theme_id" required>
                                <option value="">Sélectionnez d'abord un niveau</option>
                                {% for theme in themes %}
                                    <option value="{{ theme.id }}" data-level-id="{{ theme.level_id }}" {% if exercice.theme_id == theme.id %}selected{% endif %}>{{ theme.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="field">
                    <label class="label">Tags</label>
                    <div class="control">
                        <select class="select2-tags" name="tags" id="tags" multiple="multiple" style="width: 100%;">
                            {% for tag in all_tags %}
                                <option value="{{ tag.id }}" data-level-id="{{ tag.level_id }}" {% if tag in exercice.tags %}selected{% endif %}>{{ tag.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <p class="help">Sélectionnez des tags existants pour le niveau choisi</p>
                </div>

                <div class="field">
                    <label class="label">Contenu</label>
                    <div class="columns">
                        <div class="column">
                            <div class="control">
                                <textarea class="textarea" name="content" id="content-textarea" rows="10">{{ exercice.content }}</textarea>
                            </div>
                        </div>
                        <div class="column">
                            <p class="preview-title">Prévisualisation:</p>
                            <div id="content-preview" class="preview-box"></div>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Code LaTeX</label>
                    <div class="control">
                        <textarea class="textarea" name="latex_code">{{ exercice.latex_code }}</textarea>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Correction</label>
                    <div class="columns">
                        <div class="column">
                            <div class="control">
                                <textarea class="textarea" name="correction" id="correction-textarea" rows="10">{{ exercice.correction }}</textarea>
                            </div>
                        </div>
                        <div class="column">
                            <p class="preview-title">Prévisualisation:</p>
                            <div id="correction-preview" class="preview-box"></div>
                        </div>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Correction LaTeX</label>
                    <div class="control">
                        <textarea class="textarea" name="latex_correction">{{ exercice.latex_correction }}</textarea>
                    </div>
                </div>

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link" type="submit">Enregistrer</button>
                    </div>
                    <div class="control">
                        <a class="button is-light" href="/">Annuler</a>
                    </div>
                </div>
            </form>
        </div>
    </section>

    <script>
    $(document).ready(function() {
        // Stocker une copie de tous les tags originaux pour pouvoir les restaurer
        const allOriginalTags = $('#tags option').clone();
        
        // Stocker les valeurs initiales pour les restaurer si nécessaire
        const initialThemeId = $('#theme_id').val();
        const initialLevelId = $('#level_id').val();
        
        // Configuration initiale de Select2 pour les tags avec options avancées
        $('.select2-tags').select2({
            placeholder: "Sélectionnez des tags...",
            allowClear: true,
            templateResult: formatTagOption,
            templateSelection: formatTagSelection
        });
        
        // Fonction pour formater l'affichage des options de tags dans le dropdown
        function formatTagOption(tag) {
            if (!tag.id) {
                return tag.text;
            }
            
            const $tag = $(tag.element);
            const tagLevelId = $tag.data('level-id');
            const currentLevelId = $('#level_id').val();
            
            // Si le tag appartient au niveau actuel, l'afficher normalement
            if (tagLevelId == currentLevelId) {
                return $('<span>' + tag.text + '</span>');
            } 
            
            // Sinon, le désactiver visuellement
            return $('<span style="opacity: 0.6; text-decoration: line-through;">' + tag.text + ' (niveau différent)</span>');
        }
        
        // Fonction pour formater l'affichage des tags sélectionnés
        function formatTagSelection(tag) {
            return tag.text;
        }

        // Fonction améliorée pour filtrer les thèmes en fonction du niveau sélectionné
        function updateThemeOptions() {
            const selectedLevelId = $('#level_id').val();
            console.log('Niveau sélectionné:', selectedLevelId);
            
            // Masquer tous les thèmes d'abord
            $('#theme_id option').hide();
            $('#theme_id option[value=""]').text('Sélectionnez un thème').show();
            
            if (selectedLevelId) {
                // Afficher uniquement les thèmes du niveau sélectionné
                $(`#theme_id option[data-level-id="${selectedLevelId}"]`).show();
                
                // Si aucun thème n'est disponible pour ce niveau, afficher un message
                if ($(`#theme_id option[data-level-id="${selectedLevelId}"]`).length === 0) {
                    $('#theme_id option[value=""]').text('Aucun thème disponible pour ce niveau').show();
                    $('#theme_id').val('');
                }
            } else {
                $('#theme_id option[value=""]').text('Sélectionnez d\'abord un niveau').show();
            }
            
            // Vérifier si le thème actuellement sélectionné est disponible pour le niveau choisi
            const currentThemeId = $('#theme_id').val();
            
            if (currentThemeId && currentThemeId !== '' && !$(`#theme_id option[value="${currentThemeId}"]:visible`).length) {
                console.log(`Le thème ${currentThemeId} n'est pas visible pour le niveau ${selectedLevelId}`);
                $('#theme_id').val('');
            }
        }

        // Fonction améliorée pour gérer les tags en fonction du niveau sélectionné
        function updateTagOptions() {
            const selectedLevelId = $('#level_id').val();
            const exerciceTags = {{ exercice_tag_ids | tojson }} || [];
            
            // Détruire l'instance Select2 pour faire des modifications proprement
            $('#tags').select2('destroy');
            
            // Vider le sélecteur de tags
            $('#tags').empty();
            
            // Ajouter tous les tags mais avec des attributs de niveau
            allOriginalTags.each(function() {
                const $option = $(this).clone();
                const tagLevelId = $option.data('level-id');
                
                // Ajouter l'attribut disabled pour les tags qui ne correspondent pas au niveau actuel
                if (selectedLevelId && tagLevelId != selectedLevelId) {
                    $option.prop('disabled', true);
                } else {
                    $option.prop('disabled', false);
                }
                
                // Conserver la sélection pour les tags de l'exercice
                if (exerciceTags.includes(parseInt($option.val()))) {
                    $option.prop('selected', true);
                }
                
                $('#tags').append($option);
            });
            
            // Réinitialiser Select2
            $('#tags').select2({
                placeholder: "Sélectionnez des tags...",
                allowClear: true,
                templateResult: formatTagOption,
                templateSelection: formatTagSelection
            });
        }

        // Événement de changement de niveau
        $('#level_id').on('change', function() {
            // Mettre à jour le thème
            updateThemeOptions();
            
            // Mettre à jour les tags avec une petite temporisation pour éviter les conflits
            setTimeout(updateTagOptions, 50);
        });

        // Initialisation spéciale pour conserver la sélection initiale
        if (initialLevelId) {
            $('#level_id').val(initialLevelId);
            
            // Afficher les thèmes du niveau initial
            $(`#theme_id option`).hide();
            $(`#theme_id option[value=""]`).show();
            $(`#theme_id option[data-level-id="${initialLevelId}"]`).show();
            
            // Réappliquer la sélection de thème initiale
            if (initialThemeId) {
                $('#theme_id').val(initialThemeId);
                console.log(`Sélection initiale: niveau=${initialLevelId}, thème=${initialThemeId}`);
            }
            
            // Mettre à jour les tags
            updateTagOptions();
        } else {
            // Comportement normal si pas de sélection initiale
            updateThemeOptions();
            updateTagOptions();
        }
        
        // Validation avant soumission du formulaire
        $('form').on('submit', function(e) {
            const selectedLevelId = $('#level_id').val();
            const selectedThemeId = $('#theme_id').val();
            const selectedTags = $('#tags').val() || [];
            
            if (!selectedLevelId) {
                e.preventDefault();
                alert("Veuillez sélectionner un niveau.");
                return false;
            }
            
            if (!selectedThemeId) {
                e.preventDefault();
                alert("Veuillez sélectionner un thème.");
                return false;
            }
            
            // Vérifier si des tags de niveaux différents sont sélectionnés
            let invalidTagsSelected = false;
            $('#tags option:selected').each(function() {
                if ($(this).data('level-id') != selectedLevelId) {
                    invalidTagsSelected = true;
                    return false; // sortir de la boucle
                }
            });
            
            if (invalidTagsSelected) {
                if (!confirm("Attention: certains tags sélectionnés n'appartiennent pas au niveau choisi. Voulez-vous continuer?")) {
                    e.preventDefault();
                    return false;
                }
            }
            
            return true;
        });
    });
    
    // Le reste du code reste inchangé
    document.addEventListener('DOMContentLoaded', function() {
        // Fonction pour mettre à jour la prévisualisation (inchangée)
        function updatePreview(inputId, previewId) {
            const textarea = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            
            if (!textarea || !preview) {
                console.error(`Éléments non trouvés: ${inputId} ou ${previewId}`);
                return;
            }
            
            // Affichage de débogage
            console.log(`Initialisation de ${inputId} avec valeur:`, textarea.value);
            
            // Met à jour la prévisualisation lors de la saisie
            textarea.addEventListener('input', function() {
                console.log(`Mise à jour de ${previewId} avec:`, this.value);
                preview.innerHTML = this.value;
                
                // Re-render MathJax content
                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).catch(function(err) {
                        console.log('MathJax error:', err);
                    });
                } else {
                    console.warn('MathJax n\'est pas disponible');
                }
            });
            
            // Initialiser la prévisualisation au chargement
            setTimeout(function() {
                preview.innerHTML = textarea.value;
                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).catch(function(err) {
                        console.log('MathJax error:', err);
                    });
                }
            }, 500);
        }
        
        // Initialiser les prévisualisations
        setTimeout(function() {
            console.log('Initialisation des prévisualisations...');
            updatePreview('content-textarea', 'content-preview');
            updatePreview('correction-textarea', 'correction-preview');
        }, 300);
    });
</script>
</body>
</html>